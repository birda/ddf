<?xml version="1.0" encoding="UTF-8"?>
<!--
/**
 * Copyright (c) Codice Foundation
 *
 * This is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License as published by the Free Software Foundation, either
 * version 3 of the License, or any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU Lesser General Public License for more details. A copy of the GNU Lesser General Public License is distributed along with this program and can be found at
 * <http://www.gnu.org/licenses/lgpl.html>.
 *
 **/
 -->
<!DOCTYPE html
        PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <title>Admin UI - DDF Sources</title>
        <!-- Stylesheets -->
        <link rel="stylesheet" href="app/js/bootstrap/css/bootstrap.css" type="text/css"/>
        <link rel="stylesheet" href="app/css/sources.css" type="text/css"/>

        <!-- JavaScript -->
        <script type="text/javascript" src="app/js/underscore.js"></script>
		<script type="text/javascript" src="app/js/jquery.js"></script>
    	<script type="text/javascript" src="app/js/backbone.js"></script>
	    <script type="text/javascript" src="app/js/ICanHaz.min.js"></script>
	    <script type="text/javascript" src="app/js/bootstrap/js/bootstrap.js"></script>
	    <script type="text/javascript" src="app/js/modelbinder/Backbone.ModelBinder.js"></script>
	    <script type="text/javascript" src="app/js/modelbinder/Backbone.CollectionBinder.js"></script>
        <script type="text/javascript" src="app/js/backbone.poller.min.js"></script>
        <script type="text/javascript" src="app/client/views/ManagedServiceFactory.view.js"></script>
    	<script type="text/javascript" src="app/client/models/ManagedServiceFactory.js"></script>
        <script type="text/javascript" src="app/client/views/ManagedService.view.js"></script>
        <script type="text/javascript" src="app/client/models/ManagedService.js"></script>
    	<script type="text/javascript" src="app/client/models/Metatype.js"></script>
        <script type="text/javascript" src="app/client/models/Source.js"></script>
        <script type="text/javascript" src="app/client/views/Source.view.js"></script>
    </head>
    <body>
        <h3>Admin UI - Federated Sources</h3>
        <div id="breadcrum"></div>
        <div id="main" class="container-fluid"></div>
    </body>
    <script>
        var sList;
        var msfList;
        var msList;

        /**
         * Loading all the templates and getting the listDefaultFilteredFactoryConfiguration.
         */
        $(document).ready(function(){
            var promises = [];

            promises.push($.ajax("app/templates/editSourceTemplate.html"));
            promises.push($.ajax("app/templates/listSourceTemplate.html"));
            promises.push($.ajax({url: "app/templates/templates.json", dataType:"json"}));
            $.when.apply(null, promises).done(function(template1, template2, template3, data){
                if (template1 && template1.length > 0 && template2 && template2.length > 0 && template3 && template3.length > 0) {

                    ich.addTemplate("editTemplate", template1[0]);
                    ich.addTemplate("listTemplate", template2[0]);
                    _.each(template3[0], function(template) {
                        ich.addTemplate(template.name, template.template);
                    });
                }

                init();
            }).fail(function(error){
                if (error.status === 403) {
                    window.location.replace("/hawtio/index.html#/login");
                } else {
                    alert("an error happened " + error.statusText);
                }
            });


        });

        init = function() {
            sList = new SourceList();
            sList.fetch();

            msfList = new ManagedServiceFactory.Collection();
            msfList.fetch();

            msList = new ManagedService.Collection();
            msList.fetch();

            var options = {
                // default delay is 1000ms
                delay: 30000
            }

            var poller = Backbone.Poller.get(sList, options);
            poller.start();

            var sPage = new SourcePage({
                el: $("#main")
            });
            sPage.render();

            editRouter = new EditRouter();

            Backbone.history.start();
        }
    </script>
</html>
